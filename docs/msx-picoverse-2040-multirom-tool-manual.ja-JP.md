# MSX PicoVerse 2040 プロジェクト

|PicoVerse 前面|PicoVerse 背面|
|---|---|
|![PicoVerse Front](/images/2025-12-02_20-05.png)|![PicoVerse Back](/images/2025-12-02_20-06.png)|

PicoVerse 2040 は Raspberry Pi Pico をベースとした MSX 用カートリッジで、交換可能なファームウェアによりコンピュータの機能を拡張できます。異なるファームウェアイメージを読み込むことで、カートリッジは MSX のゲームやアプリケーションを実行したり、追加のハードウェアデバイス（ROM マッパー、追加 RAM、ストレージインターフェースなど）をエミュレートして、MSX に仮想周辺機器を追加できます。MultiROM システムはその一つで、カートリッジに格納された複数の ROM タイトルを参照および起動するためのオンスクリーンメニューを提供します。

カートリッジはまた、Pico の USB‑C ポートをマスストレージデバイスとして露出させることができ、Windows や Linux の PC から ROM、DSK、その他のファイルをカートリッジに直接コピーできます。

さらに、+240 KB メモリマッパーをサポートする Nextor ファームウェアのバリアントを使用することで、メモリが限られた MSX システムでも PicoVerse 2040 ハードウェアをフルに活用できます。

以下は PicoVerse 2040 カートリッジの現行バージョンで利用可能な機能です:

* ROM を選択して起動するための MultiROM メニューシステム。
* オプションの +240 KB メモリマッパーをサポートする Nextor OS。
* ROM や DSK をロードするための USB マスストレージサポート。
* 各種 MSX ROM マッパーのサポート（PL-16、PL-32、KonSCC、Linear、ASC-08、ASC-16、Konami、NEO-8、NEO-16）。
* MSX、MSX2、MSX2+ システムとの互換性。

## MultiROM UF2 作成ツール マニュアル

このセクションでは、PicoVerse 2040 カートリッジに書き込む UF2 イメージ（`multirom.uf2`）を生成するためのコンソールツール `multirom` について説明します。

デフォルトでは、`multirom` ツールはディレクトリ内の MSX ROM ファイルをスキャンして、それらを単一の UF2 イメージにパッケージ化します。生成されるイメージには通常、Pico のファームウェア、MultiROM MSX メニュー ROM、各 ROM エントリを記述する設定領域、および ROM 本体が含まれます。

> **注意:** 1 つのイメージに最大 128 本の ROM を含めることができ、合計サイズは約 16 MB が上限です。

オプションに応じて、`multirom` は MultiROM メニューの代わりにカスタムファームウェアで直接ブートする UF2 イメージを生成することもできます。たとえば、Nextor を実装するファームウェアを含む UF2 を生成することが可能です。このモードでは、Pico の USB‑C ポートが Nextor から ROM、DSK、その他のファイルをロードするためのマスストレージデバイスとして使用できます（例: SofaRun 経由）。

## 概要

オプション無しで実行すると、`multirom.exe` はカレントワーキングディレクトリ内の MSX ROM ファイル（`.ROM` または `.rom`）をスキャンし、各 ROM を解析してマッパータイプを推定し、各 ROM を記述する設定テーブル（名前、マッパーバイト、サイズ、オフセット）を構築して MSX メニュー ROM のスライスに埋め込みます。ツールは次に Pico ファームウェアのバイナリ、メニュースライス、設定領域および ROM 本体を連結して、`multirom.uf2` という UF2 ファイルにシリアライズします。

![alt text](/images/2025-11-29_20-49.png)

生成された UF2 ファイル（通常は `multirom.uf2`）は、Pico を BOOTSEL ボタンを押しながら接続して UF2 書き込みモードに入れた後、Pico の USB マスストレージとして表示されるドライブ `RPI-RP2` にコピーしてフラッシュできます。コピーが完了したら Pico を抜き、カートリッジを MSX に挿入して MultiROM メニューを起動します。

ROM ファイル名は MSX メニューのエントリ名として使用されます。1 つの名前は最大 50 文字までです。長い名前はメニューでスクロール表示されますが、50 文字を超えると切り詰められます。

![alt text](/images/multirom_2040_menu.png)

> **注意:** USB メモリを使用する場合は OTG アダプタまたはケーブルが必要な場合があります。これにより USB‑C ポートを標準の USB‑A メスに変換できます。

> **注意:** `-n` オプションは特定の MSX2 モデルで動作する実験的な埋め込み Nextor ROM を含みます。このバージョンは IO ポートベースの異なる通信方法を使用しており、すべてのシステムで動作するとは限りません。

## コマンドラインの使い方

現時点では Windows 実行可能ファイル（`multirom.exe`）のみが提供されています。

### 基本的な使い方:

```
multirom.exe [options]
```

### オプション:
- `-n`, `--nextor` : 設定および出力にベータ版の埋め込み NEXTOR ROM を含めます。このオプションはまだ実験的で、現時点では特定の MSX2 モデルでのみ動作します。
- `-h`, `--help`   : ヘルプを表示して終了します。
- `-o <filename>`, `--output <filename>` : 出力 UF2 ファイル名を設定します（デフォルトは `multirom.uf2`）。
- 特定の ROM ファイルに対してマッパータイプを強制する必要がある場合は、ファイル名の `.ROM` 拡張子の前にマッパータグを付けることができます。タグは大文字小文字を区別しません。例えば `Knight Mare.PL-32.ROM` と名付けると、その ROM に対して PL-32 マッパーの使用が強制されます。`SYSTEM` のようなタグは無視されます。使用できるタグの一覧は次の通りです: `PL-16,  PL-32,  KonSCC,  Linear,  ASC-08,  ASC-16,  Konami,  NEO-8,  NEO-16`

### 例
- カレントディレクトリ内のすべての `.ROM` ファイルと MultiROM メニューを含む `multirom.uf2` を生成します。コマンドプロンプトからツールを実行するか、実行ファイルをダブルクリックしてください:
  ```
  multirom.exe
  ```

## 動作の仕組み（高レベル）

1. ツールはカレントワーキングディレクトリ内の `.ROM` または `.rom` で終わるファイルをスキャンします。各ファイルについて:
   - 表示名（拡張子を除いたファイル名、50 文字に切り詰め）を抽出します。
   - ファイルサイズを取得し、それが `MIN_ROM_SIZE` と `MAX_ROM_SIZE` の間であることを検証します。
   - `detect_rom_type()` を呼び出して、設定エントリに使用するマッパーバイトをヒューリスティックに決定します。ファイル名にマッパータグがある場合は検出を上書きします。
   - マッパー検出に失敗した場合、ファイルはスキップされます。
   - ROM ごとの設定レコード（50 バイトの名前、1 バイトのマッパー、4 バイトのサイズ LE、4 バイトのフラッシュオフセット LE）を設定領域に直列化します。
2. スキャン後、ツールは次を順に連結します: 埋め込み Pico ファームウェアバイナリ、MSX メニュー ROM の先頭スライス（`MENU_COPY_SIZE` バイト）、完全な設定領域（`CONFIG_AREA_SIZE` バイト）、オプションの NEXTOR ROM、そして発見された ROM ペイロード。
3. 結合されたペイロードは `create_uf2_file()` を使用して `multirom.uf2` という UF2 ファイルとして書き込まれます。これは Pico のフラッシュアドレス `0x10000000` をターゲットとする 256 バイトの UF2 ペイロードブロックを生成します。

## マッパー検出のヒューリスティクス
- `detect_rom_type()` は署名チェック（"AB" ヘッダ、`ROM_NEO8` / `ROM_NE16` タグ）と、オペコードやアドレスのヒューリスティックなスキャンを組み合わせて、以下を含む一般的な MSX マッパーを選択します（これに限定されません）:
  - Plain 16KB（マッパーバイト 1）— 16KB AB ヘッダチェック
  - Plain 32KB（マッパーバイト 2）— 32KB AB ヘッダチェック
  - Linear0 マッパー（マッパーバイト 4）— 特殊な AB レイアウトチェック
  - NEO8（マッパーバイト 8）および NEO16（マッパーバイト 9）
  - Konami、Konami SCC、ASCII8、ASCII16 などを重み付けスコアリングで判定
- 信頼してマッパーを検出できない場合、ツールは ROM をスキップし "unsupported mapper" と報告します。ファイル名のタグでマッパーを強制できることを忘れないでください。タグは大文字小文字を区別せず、下記に一覧があります。
- 設定領域とメニューでサポートされているマッパーは次のとおりです: `PL-16,  PL-32,  KonSCC,  Linear,  ASC-08,  ASC-16,  Konami,  NEO-8,  NEO-16`

## MSX ROM セレクタメニューの使い方

PicoVerse 2040 カートリッジを挿入して MSX の電源を入れると、利用可能な ROM の一覧を表示する MultiROM メニューが現れます。矢印キーでメニューを操作できます。

![alt text](/images/multirom_2040_menu.png)

上/下 の矢印キーで選択カーソルを移動します。ROM が 19 本以上ある場合は、左右の矢印キーでエントリのページをスクロールします。

Enter または Space キーを押すと、選択した ROM が起動されます。MSX は適切なマッパー設定を使って ROM のブートを試みます。

メニュー中にいつでも H キーを押すと基本的な操作説明が表示されます。任意のキーを押すとメインメニューに戻ります。

## PicoVerse 2040 カートリッジで Nextor を使う

multirom ツールの `-n` オプションは、特定の MSX2 モデルで使用できる実験的な埋め込み Nextor ROM を含めます。しかしこのオプションは開発中であり、すべてのシステムで動作するとは限りません。このバージョンは IO ポートベースの異なる通信方法を用い、カートリッジスロットがプライマリでないシステム（スロットエクスパンダを使用する場合など）でも動作することを可能にします。

MSX コンピュータと通信するために使用されるプロトコルの詳細は、Nextor-Pico-Bridge-Protocol.md ドキュメントを参照してください。

### Nextor 用の USB メモリの準備方法

Nextor を PicoVerse 2040 カートリッジで使用するための USB メモリを準備する手順は次の通りです:

1. USB メモリを PC に接続します。
2. USB メモリに最大 4GB の FAT16 パーティションを作成します。Nextor の組み込みツール（MSX Basic で CALL FDISK）やサードパーティのパーティションソフトを使用できます。
3. Nextor のシステムファイルを FAT16 パーティションのルートディレクトリにコピーします。Nextor のシステムファイルは公式の Nextor 配布物またはリポジトリから入手できます。コマンドシェル用に COMMAND2 ファイルも必要です:
   1.  [Nextor ダウンロードページ](https://github.com/Konamiman/Nextor/releases)
   2.  [Command2 ダウンロードページ](http://www.tni.nl/products/command2.html)
4. Nextor で使用したい MSX ROM（`.ROM`）やディスクイメージ（`.DSK`）を USB メモリのルートディレクトリにコピーします。
5. ROM や DSK を起動するために SofaRun や他の Nextor 対応ランチャーを USB メモリにインストールする場合は、SofaRun を次からダウンロードできます: [SofaRun](https://www.louthrax.net/mgr/sofarun.html)
6. USB メモリを PC から安全に取り外します。
7. 必要に応じて OTG アダプタやケーブルを使って USB メモリを PicoVerse 2040 カートリッジに接続します。

> **注意:** すべての USB メモリが PicoVerse 2040 カートリッジと互換性があるわけではありません。問題が発生した場合は別のブランドや型番を試してください。
>
> **注意:** Nextor の動作には最低 128 KB の RAM が必要です。

## 改善案
- ROM タイプ検出のヒューリスティクスを改善して、より多くのマッパーやエッジケースをカバーする。
- 各 ROM エントリの設定画面（名前、マッパー上書き等）を実装する。
- さらに多くの ROM マッパーのサポートを追加する。
- ナビゲーションや ROM 情報表示を改善したグラフィカルメニューを実装する。
- ユーザー設定を保持するためにメニュー設定の保存/読み込みを追加する。
- DSK ファイルのサポートを追加し、適切な設定エントリを用意する。
- メニューのカスタムテーマをサポートする。
- インターネットの URL から ROM をダウンロードして直接埋め込む機能を追加する。
- ジョイスティックでメニューを操作できるようにする。

## 既知の問題

- 埋め込み Nextor ROM の包含はまだ実験的で、すべての MSX2 モデルで動作するとは限らない。
- 珍しいマッパーを持つ一部の ROM は正しく検出されず、マッパータグで強制しない限りスキップされることがある。
- MultiROM ツールは現在 Windows のみをサポートしている。Linux や macOS 向けのバージョンはまだ用意されていない。
- ツールは現在、ファイルサイズと基本的なヘッダ検査以外の方法で ROM の整合性を検証していない。破損した ROM は予期しない動作を引き起こす可能性がある。
- 複数のファイルを単一の UF2 に埋め込む性質上、一部のアンチウィルスが実行ファイルを疑わしいと判断する場合がある。これは誤検知であることが多い; 信頼できるソースからツールを入手してください。
- MultiROM メニューは DSK ファイルをサポートしていない; ROM ファイルのみが一覧表示および起動される。
- ツールは現在サブディレクトリをサポートしていない; カレントディレクトリ内の ROM のみが処理される。
- 多数の書き込みサイクルの後、Pico のフラッシュメモリは摩耗する可能性がある。過度の再フラッシュを避けてください。

## テスト済み MSX モデル

MultiROM ファームウェアを搭載した PicoVerse 2040 カートリッジは以下の MSX モデルでテストされています:

| モデル | 種類 | 状態 | コメント |
| --- | --- | --- | --- |
| Adermir Carchano Expert 4 | MSX2+ | OK | 動作確認済み |
| Gradiente Expert | MSX1 | OK | 動作確認済み |
| JFF MSX | MSX1 | OK | 動作確認済み |
| MSX Book | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| MSX One | MSX1 | Not OK | カートリッジが認識されない |
| National FS-4500 | MSX1 | OK | 動作確認済み |
| Omega MSX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1GT | TurboR | OK | 動作確認済み |
| Panasonic FS-A1ST | TurboR | OK | 動作確認済み |
| Panasonic FS-A1WX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1WSX | MSX2+ | OK | 動作確認済み |
| Sharp HotBit HB8000 | MSX1 | OK | 動作確認済み |
| SMX-HB | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Sony HB-F1XD | MSX2 | OK | 動作確認済み |
| Sony HB-F1XDJ | MSX2 | OK | 動作確認済み |
| Sony HB-F1XV | MSX2+ | OK | 動作確認済み |
| TRHMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Yamaha YIS604 | MSX1 | OK | 動作確認済み |

実験的な埋め込み Nextor ROM (オプション `-n`) は次のモデルでテストされています:

| モデル | 種類 | 状態 | コメント |
| --- | --- | --- | --- |
| Omega MSX | MSX2+ | Not OK | USB が検出されない |
| Sony HB-F1XD | MSX2 | Not OK | ディスクセクタの読み取りエラー |
| TRHMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |

作者: Cristiano Almeida Goncalves
最終更新: 12/25/2025
